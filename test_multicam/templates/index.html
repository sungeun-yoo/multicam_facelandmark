<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>두 개의 웹캠</title>
    <style>
        /* 스타일 추가 */
        .webcam-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            position: relative;
        }
        video, canvas {
            border-radius: 15px;
            overflow: hidden;
            position: absolute;
            cursor: grab;
        }
        canvas {
            z-index: 2;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- 웹캠을 감싸는 컨테이너 추가 -->
    <div class="webcam-container">
      <video id="webcam1" width="320" height="240" autoplay playsinline></video>
      <canvas id="canvas1" width="320" height="240"></canvas>
      <video id="webcam2" width="320" height="240" autoplay playsinline></video>
      <canvas id="canvas2" width="320" height="240"></canvas>
  </div>

    <script src="static/mouse.js" defer></script>
    <script>
        async function initWebcams() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');

                if(videoDevices.length < 2) {
                    alert("두 개 이상의 웹캠이 필요합니다.");
                    return;
                }

                const stream1 = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: videoDevices[0].deviceId }
                });
                document.getElementById('webcam1').srcObject = stream1;

                const stream2 = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: videoDevices[1].deviceId }
                });
                document.getElementById('webcam2').srcObject = stream2;
            } catch(err) {
                alert("웹캠을 불러오는 중 에러가 발생했습니다.");
                console.error(err);
            }
        }
        window.onload = initWebcams;

        const rectangleWorker = new Worker('static/rectangleWorker.js');
        const circleWorker = new Worker('static/circleWorker.js');
        const canvas1 = document.getElementById('canvas1');
        const ctx1 = canvas1.getContext('2d');
        const canvas2 = document.getElementById('canvas2');
        const ctx2 = canvas2.getContext('2d');
        // canvas의 배경색을 회색으로 설정
        ctx1.fillStyle = 'gray';
        ctx1.fillRect(0, 0, canvas1.width, canvas1.height);
        ctx2.fillStyle = 'gray';
        ctx2.fillRect(0, 0, canvas2.width, canvas2.height);
        rectangleWorker.onmessage = function(event) {
            const { x, y, width, height } = event.data;
            ctx1.clearRect(0, 0, canvas1.width, canvas1.height); // 이전 사각형 제거
            ctx1.strokeRect(x, y, width, height);
        };

        circleWorker.onmessage = function(event) {
            const { cx, cy, radius } = event.data;
            ctx2.clearRect(0, 0, canvas2.width, canvas2.height); // 이전 원 제거
            ctx2.beginPath();
            ctx2.arc(cx, cy, radius, 0, 2 * Math.PI);
            ctx2.stroke();
        };

        function processFrames() {
            // 웹캠1 프레임 캡처
            const canvas1 = document.getElementById('canvas1');
            const ctx1 = canvas1.getContext('2d');
            ctx1.drawImage(document.getElementById('webcam1'), 0, 0, canvas1.width, canvas1.height);
            const frameData1 = ctx1.getImageData(0, 0, canvas1.width, canvas1.height);

            // 웹캠2 프레임 캡처
            const canvas2 = document.getElementById('canvas2');
            const ctx2 = canvas2.getContext('2d');
            ctx2.drawImage(document.getElementById('webcam2'), 0, 0, canvas2.width, canvas2.height);
            const frameData2 = ctx2.getImageData(0, 0, canvas2.width, canvas2.height);

            // 웹 워커로 프레임 데이터 전송
            rectangleWorker.postMessage(frameData1);
            circleWorker.postMessage(frameData2);

            // 계속해서 프레임 처리
            requestAnimationFrame(processFrames);
        }


        window.onload = function() {
            initWebcams();
            processFrames(); // 프레임 처리 시작
        };

    </script>
</body>
</html>
